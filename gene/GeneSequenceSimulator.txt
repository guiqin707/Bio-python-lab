# 第一部分：模拟基因序列数据

import numpy as np
import pandas as pd
import random
from Bio.Seq import Seq
from Bio.SeqRecord import SeqRecord
from Bio import SeqIO
from scipy import stats
import matplotlib.pyplot as plt

# 设置随机种子以便可重复结果
np.random.seed(42)
random.seed(42)

class GeneSequenceSimulator:
    """模拟基因序列和表达数据的类"""

    def __init__(self, num_genes=1000, seq_length=1500):
        self.num_genes = num_genes
        self.seq_length = seq_length
        self.nucleotides = ['A','C','G','T']

    def generate_random_sequence(self):
        """生成随机DNA序列"""
        return ''.join(random.choices(self.nucleotides, k=self.seq_length))

    def generate_gene_data(self):
        """生成完整的基因数据集"""
        genes = []

        print("正在生成模拟基因数据 ...")
        for i in range(self.num_genes):
            #生成基因ID
            gene_id = f"GENE_{i+1:04d}" # i+1:04d = 把数字格式化为4位数，不足补0

            #随机生成序列
            sequence = self.generate_random_sequence()

            #随机添加肯的ORF（开放阅读框）
            if random.random() > 0.3: #70%的基因有ORF
                # random.random() = 生成0到1之间的随机数
                # > 0.3 = 如果随机数大于0.3，说明有70%的概率进入if
                start_codon = random.randint(100, 300)
                if start_codon + 300 <self.seq_length:
                    #在序列中插入起始密码子ATG
                    sequence = (sequence[:start_codon] + 'ATG' +
                                sequence[start_codon+3:])


            #生成模拟的表达数据
            genes.append({
                'gene_id' : gene_id,
                'sequence' : sequence,
                'length' : len(sequence),
                'gc_content': (sequence.count('G') + sequence.count('C')) / len(sequence) * 100
            })
        return pd.DataFrame(genes)

    def generate_expression_data(self, genes_df, num_samples=10):
        """生成模拟的表达矩阵"""
        print("正在生成表达数据...")

        #创建样本名称
        sample_names = [f'Normal_{i}' for i in range(num_samples//2)] +\
                [f'Cancer_{i}' for i in range(num_samples//2)]

        #创建表达矩阵
        expression_data = {}

        for gene_id in genes_df['gene_id']:
            #为每个基因生成基础表达水平
            base_expression = np.random.lognormal(mean=3, sigma=1.5)
            #随机选择一些差异表达基因
            is_de = random.random() < 0.1#10%的基因为差异基因

            normal_expr = []
            cancer_expr = []

            for j in range(num_samples//2):
                #正常样本表达
                normal_expr.append(np.random.lognormal(
                    mean=np.log(base_expression),
                    sigma=0.5
                ))

                #癌症样本表达
                if is_de:
                        #差异表达基因：癌症样本中表达改变
                    fold_change = random.choice([0.2, 0.5, 2, 5])#表达变化倍数
                    cancer_base = base_expression * fold_change
                else:
                    cancer_base = base_expression

                cancer_expr.append(np.random.lognormal(
                        mean=np.log(cancer_base),
                        sigma=0.5
                    ))

            expression_data[gene_id] = normal_expr + cancer_expr

        expr_df = pd.DataFrame(expression_data, index=sample_names).T
        return expr_df
        #生成模拟数据
simulator = GeneSequenceSimulator(num_genes=500, seq_length=1500)
genes_df = simulator.generate_gene_data()
expression_df = simulator.generate_expression_data(genes_df, num_samples=20)


print("数据生成完成！")
print(f"基因数量：{len(genes_df)}")
print(f"样本数量：{len(expression_df.columns)}")
print(f"表达矩阵形状：{expression_df.shape}")
print("\n基因数据前5行：")
print(genes_df.head())
print("\n表达数据前5行前5列：")
print(expression_df.iloc[:5, :5])

